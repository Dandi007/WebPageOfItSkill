(function(){var __indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};$(function(){system.gate.guideFloatDisabled=1;return $.require("ready",function(){var _base;system.func.saveHistory=function(param){var i,list,p,v,_i,_len;if(window.localStorage){list=cache.history[param];if(!list){cache.history[param]=[]}for(i=_i=0,_len=list.length;_i<_len;i=++_i){v=list[i];if(system.post.aid===v.aid){list.splice(i,1);break}}list.push({time:$.now(),date:(p=system.post).date,aid:p.aid,title:p.title,desc:p.desc||"此视频未填写简介。",cid:p.cid,tags:p.tags,preview:p.preview,views:p.views,comms:p.comms,favors:p.favors,shares:p.shares,uid:p.uid,name:p.name,avatar:p.avatar});if(list.length>100){list.splice(0,1)}return $.save("cache")}};(function(){var a,elem,f,n,_i,_j,_len,_len1,_ref,_ref1;elem=$$("#block-data-view");f=function(p){return $.parseSafe(elem.data(p)||"")};n=function(p){return(elem.data(p)||0)|0};system.post={};_ref=["name","avatar","title","tags","preview"];for(_i=0,_len=_ref.length;_i<_len;_i++){a=_ref[_i];system.post[a]=f(a)}_ref1=["uid","aid","cid","views","comms","favors","shares","time"];for(_j=0,_len1=_ref1.length;_j<_len1;_j++){a=_ref1[_j];system.post[a]=n(a)}system.post.desc=$$("#block-info-view").find("p.shadow").text();system.post.tags=system.post.tags.split(",");return system.post.date=$.timeStamp(elem.data("date"))})();if(typeof(_base=system.func).readyPlayer==="function"){_base.readyPlayer()}(function(){var area,btn;area=$$("#area-part-view");system.post.parts=area.data().parts|0;system.post.part=area.data().part|0;if(area.data().parts>2){btn=$$("#btn-more-part");return btn.data({active:0}).click(function(){if(!btn.data().active){btn.data({active:1}).addClass("active").find("p").text("收起").end().find("i").addClass("icon-minus-sign").removeClass("icon-plus-sign");return area.addClass("active").scrollOnto(0).children("div.l").scrollTop((area.find("a.active").eq(0).index()-1)*32)}else{btn.data({active:0}).removeClass("active").find("p").text("展开").end().find("i").addClass("icon-plus-sign").removeClass("icon-minus-sign");return area.removeClass("active")}})}})();(function(){var html,obj;obj=$("#block-info-view p.desc:not(.shadow)");html=obj.html();html=html.replace(/(?:(?:http:\/\/)?[\w\/\.\-]+?acfun\.[\w\/\.\-]+?)?\[?ac(\d+(?:_\d+)?)\]?/g,'<a href="http://www.acfun.tv/v/ac$1" target="_blank">[ac$1]</a>').replace(/(?:(?:http:\/\/)?[\w\/\.\-]+?acfun\.[\w\/\.\-]+?)?\[?aa(\d+)\]?/g,'<a href="http://www.acfun.tv/a/aa$1" target="_blank" title="该链接通向AcFun合辑">[aa$1]</a>').replace(/(?:(?:http:\/\/)?[\w\/\.\-]+?nicovideo\.[\w\/\.\-]+?)?\[?sm(\d+)\]?/g,'<a href="http://www.nicovideo.jp/watch/sm$1" title="该链接通向ニコニコ动画" target="_blank">[sm$1]</a>').replace(/\[wiki(\S+?)\]/g,'<a href="http://wiki.acfun.tv/index.php/$1" title="该链接通向AC百科" target="_blank">[$1]</a>');return obj.html(html)})();(function(){var block,btn,obj,shadow;block=$$("#block-info-view");obj=block.find("p.desc:not(.shadow)");shadow=block.find("p.shadow");if(shadow.height()>48){btn=$("#btn-toggle-desc");btn.removeClass("hidden").data({active:0}).click(function(){if(!btn.data().active){obj.css({height:"auto"});return btn.text("[-折叠简介]").data({active:1})}else{obj.css({height:48});return btn.text("[+展开简介]").data({active:0})}})}return shadow.remove()})();(function(){var p;window.bds_config={bdText:(p=system.post).title+" Up主："+p.name+"  \n"+"来自AcFun"+$.parseChannel(p.cid|0)+"频道",bdPic:p.preview,snsKey:{tsina:529993022,tqq:801259307,t163:"",tsohu:""}};return $("#bdshell_js")[0].src="http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion="+Math.ceil(new Date/36e5)})();(function(){var area,btn;area=$$("#area-tag-view");btn=$$("#btn-add-tag");if(user.online){if(area.data().active){btn.click(function(){var levelLimit,tags,text;levelLimit=5;if(user.level>=levelLimit){tags=area.find("span.tag");if(tags.length<10){return btn.call({src:"win-tag-view",id:"win-tag-view","class":"win-children",title:"添加标签",icon:"plus-sign",width:520,height:"auto"})}else{text="warning::该视频标签数目已达上限。";$.info(text);return btn.info(text)}}else{text="warning::用户等级不足["+levelLimit+"]。无权添加标签。";$.info(text);return btn.info(text)}}).removeClass("hidden")}else{btn.addClass("disabled").text("该视频被设置为禁止添加标签").removeClass("hidden")}}if(user.group===2&&(user.uid|0)===system.post.uid){user.group=3}if(user.group===0||user.group===3){return area.addClass("manage").delegate("div.btn-delete","click",function(){var tag,v;tag=$(this).closest("span.tag");v=$.trim($.parseSafe(tag.text().replace(/\(.*/,"")));return tag.ensure({curtain:true,text:"是否确认删除标签["+v+"]？",callback:function(){var _ref;if((_ref=btn.data().port)!=null){_ref.abort()}return btn.data().port=$.post("/delTag.aspx",{contentId:system.post.aid,tagId:tag.data().tid}).done(function(data){if(data.success){tag.stop().transition({opacity:0},200,function(){return tag.remove()});$.info("info::删除标签["+v+"]成功。");return $$("#curtain").click()}else{return $.info("warning::"+data.result)}}).fail(function(){return $.info("error::同服务器通信失败。请于稍后重试。")})}})})}})();(function(){var area,f;$.i("更新视频信息…");area=$$("#txt-info-title");area.data({post:null});f=function(){f.a();return f.b()};f.a=function(){return $.get("/content_view.aspx",{contentId:system.post.aid,channelId:system.post.cid,shareUid:system.hash.shareUid!==user.uid?system.hash.shareUid:null}).done(function(data){var arr,n,pts;arr=data.toString().split(",");pts=area.children("span.pts");pts.eq(0).text($.parsePts(arr[0]));n=arr[1]>9999?Math.round(arr[1]/1e3)/10+"万":$.parsePts(arr[1]);pts.eq(1).text($.parsePts(arr[1]));$$("#btn-comm-view span").text(n);$$("#btn-top-shortcut").find("div.btn-to-comment span.pts").text(n);n=arr[3]>9999?Math.round(arr[3]/1e3)/10+"万":$.parsePts(arr[3]);$$("#btn-up-toolbar").find("span").text($.parsePts(arr[3]));$$("#btn-up-view").find("span").text(n);n=arr[5]>9999?Math.round(arr[5]/1e3)/10+"万":$.parsePts(arr[5]);pts.eq(2).text($.parsePts(arr[5]));$$("#btn-favor-toolbar").find("span").text($.parsePts(arr[5]));return $$("#btn-favor-view").find("span.pts").text(n)}).fail(function(){var text;text="视频播放信息读取失败";return area.text(text)})};f.b=function(){return $.get("/member/collect_up_exist.aspx",{contentId:system.post.aid}).done(function(data){var a,html,inner,temp,_i,_len,_ref;if(data.success){if(data.data.collect){system.post.isFavored=1;$$("#btn-favor-view").data({active:1}).add("#btn-favor-toolbar").addClass("active").find("p").text("已收藏")}else{system.post.isFavored=0;$$("#btn-favor-view").data({active:0}).add("#btn-favor-toolbar").removeClass("active").find("p").text("收藏")}if(data.data.up){system.post.isUped=1;$$("#btn-up-view").data({active:1}).add("#btn-up-toolbar").addClass("active").find("p").text("已点赞")}else{system.post.isUped=0}if(data.data.follow){system.post.isFollowing=1;$$("#btn-follow-author").addClass("active").data({active:1}).text("已关注")}else{system.post.isFollowing=0;$$("#btn-follow-author").removeClass("active").data({active:0}).text("关注")}if(data.data.tagList){inner=$("#area-tag-view span.inner");temp=$("#temp-tag-view").html();html="";_ref=data.data.tagList;for(_i=0,_len=_ref.length;_i<_len;_i++){a=_ref[_i];html+=$.parseTemp(temp,{tid:a.tagId,name:$.parseSafe(a.tagName),count:$.parsePts(a.refCount)})}return inner.html(html)}}})};(system.func.rvi=f)();if(system.st-system.post.date<864e5*30){return(f.d=function(){var a;if(f.t){f.a()}else{f.t=5}setTimeout(f.d,f.t*6e4);return f.t=(a=f.t*2)>30?30:a})()}})();(function(){var btns,elem;elem=$$("#btn-favor-view");btns=elem.add("#btn-favor-toolbar");return btns.click(function(){var btn,direction,text,_ref;btn=$(this);direction=btn.is(elem)?"top":"bottom";if(!btn.hasClass("disabled")){btns.addClass("disabled");setTimeout(function(){return btns.removeClass("disabled")},1e3);if(user.online){if((_ref=elem.data().port)!=null){_ref.abort()}return elem.data().port=$.post("/member/collect.aspx",{cId:system.post.aid,operate:elem.data().active?0:1}).done(function(data){var text;if(data.success){if(!elem.data().active){text="success::已收藏当前视频。";$.info(text);btn.info({direction:direction,text:text});elem.data({active:1});btns.addClass("active").find("p").text("已收藏");return system.func.rvi()}else{text="info::已取消当前视频收藏。";$.info(text);btn.info({direction:direction,text:text});elem.data({active:0});btns.removeClass("active").find("p").text("收藏");return system.func.rvi()}}else{text="warning::"+data.result;$.info(text);return btn.info({direction:direction,text:text})}}).fail(function(){var text;text="warning::收藏操作失败。请于稍后重新操作。";$.info(text);return btn.info({direction:direction,text:text})})}else{text="warning::您尚未登录。请先行登录。";$.info(text);return btn.info({direction:direction,text:text}).call("login")}}})})();(function(){var btns,elem;elem=$$("#btn-up-view");btns=elem.add("#btn-up-toolbar");return btns.click(function(){var btn,direction,text,_ref;btn=$(this);direction=btn.is(elem)?"top":"bottom";if(!btn.hasClass("disabled")){btns.addClass("disabled");setTimeout(function(){return btns.removeClass("disabled")},1e3);if(user.online){if(!elem.data().active){if((_ref=elem.data().port)!=null){_ref.abort()}return elem.data().port=$.post("/content_up.aspx",{contentId:system.post.aid}).done(function(data){var text;if(data.success){text="success::点赞成功。";$.info(text);btn.info({direction:direction,text:text});elem.data({active:1});btns.addClass("active").find("p").text("已点赞");system.func.rvi();return system.func.saveHistory("ups")}else{text="warning::"+data.result;$.info(text);return btn.info({direction:direction,text:text})}}).fail(function(){var text;text="warning::点赞操作失败。请于稍后重新操作。";$.info(text);return btn.info({direction:direction,text:text})})}else{text="warning::请勿重复点赞。";$.info(text);return btn.info({direction:direction,text:text})}}else{text="warning::您尚未登录。请先行登录。";$.info(text);return btn.info({direction:direction,text:text}).call("login")}}})})();$$("#btn-comm-view").click(function(){return $$("#area-bottom-view").scrollOnto()});$$("#btn-follow-author").click(function(){var btn;btn=$(this);if(!btn.hasClass("disabled")){btn.addClass("disabled");setTimeout(function(){return btn.removeClass("disabled")},1e3);if(!btn.data().active){return btn.call("follow",function(){return $("#win-follow").data({name:btn.data().name,uid:btn.data().uid,callback:system.func.rvi})})}else{return btn.ensure({curtain:true,text:"是否确认取消关注？",callback:function(){var _ref;if((_ref=btn.data().port)!=null){_ref.abort()}return btn.data().port=$.post("/api/friend.aspx?name=unfollow",{username:btn.data().name,userId:btn.data().uid,groupId:0}).done(function(data){var text;if(data.success){text="info::取消关注["+$.parseSafe(btn.data().name)+"]成功。";$.info(text);btn.info(text);return system.func.rvi()}else{text="warning::"+data.result;$.info(text);return btn.info(text)}}).fail(function(){var text;text="error::取消关注["+$.parseSafe(btn.data().name)+"]失败。请于稍后重试。";$.info(text);return btn.info(text)})}})}}});if(system.type==="article"){$$("#btn-top-shortcut").off()}$.require("comm",function(){var _base1;return typeof(_base1=$$("#area-comment").data().func).ready==="function"?_base1.ready(function(){var btn;btn=$$("#btn-showComm");if(config.comment.autoShowCommentAllowed){return setTimeout(function(){return btn.click()},1e3)}else{return btn.css({display:"block"})}}):void 0});(function(){if(system.type==="article"&&(system.post.cid===75&&$("#area-player").find("img").length>1||system.post.cid!==75&&$("#area-player").find("img").length>8)){return $.getScript(system.path.short+"/project/homura/script/manga.min.js"+$.salt(7))}})();(function(){return setTimeout(function(){return system.func.saveHistory("views")},1e4)})();return function(){var cid,k,v,_ref;cid=system.post.cid;_ref=$.parseChannel.map;for(k in _ref){v=_ref[k];if(__indexOf.call(v,cid)>=0){cid=k;break}}return $$("#guide-inner").children(".l").find('a[href="/v/list'+cid+'/index.htm"]').addClass("current")}()})})}).call(this);